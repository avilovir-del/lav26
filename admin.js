let authToken = null;
const API_BASE = window.location.origin;

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
async function apiCall(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': authToken,
                ...options.headers
            },
            ...options
        });

        if (response.status === 401) {
            logout();
            throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        }

        return await response.json();
    } catch (error) {
        console.error('API Error:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
        throw error;
    }
}

// –£–ª—É—á—à–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
  // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π toast –≤–º–µ—Å—Ç–æ alert
  const notification = document.createElement('div');
  notification.innerHTML = `
    <div style="
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3'};
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      max-width: 400px;
      animation: slideInRight 0.3s ease;
      font-weight: 600;
    ">
      ${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'} ${message}
    </div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease forwards';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 4000);
}

// –î–æ–±–∞–≤–∏–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
async function login() {
    const password = document.getElementById('admin-password').value;
    
    if (!password) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', 'error');
        return;
    }

    try {
        const result = await apiCall('/api/admin/login', {
            method: 'POST',
            body: JSON.stringify({ password })
        });

        if (result.success) {
            authToken = result.token;
            localStorage.setItem('adminToken', authToken);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadDashboard();
        } else {
            showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
    }
}

// –í—ã—Ö–æ–¥
function logout() {
    authToken = null;
    localStorage.removeItem('adminToken');
    document.getElementById('login-screen').style.display = 'block';
    document.getElementById('admin-panel').style.display = 'none';
    document.getElementById('admin-password').value = '';
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è
function showSection(sectionName) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.getElementById(`section-${sectionName}`).classList.add('active');
    
    document.querySelectorAll('.nav-tabs button').forEach(button => {
        button.classList.remove('active');
    });
    event.target.classList.add('active');

    switch(sectionName) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'submissions':
            loadSubmissions();
            break;
        case 'purchases':
            loadPurchaseRequests();
            break;
        case 'users':
            loadUsers();
            break;
        case 'tasks':
            loadTasks();
            break;
        case 'shop':
            loadShop();
            break;
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞
async function loadDashboard() {
    try {
        const stats = await apiCall('/api/admin/stats');
        const users = await apiCall('/api/admin/users');
        
        const activeUsers = users.filter(user => {
            if (!user.lastActivity) return false;
            const lastActivity = new Date(user.lastActivity);
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            return lastActivity > weekAgo;
        });

        const statsHTML = `
            <div class="stat-card">
                <div class="stat-number">${stats.totalUsers}</div>
                <div class="stat-label">üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.activeUsers}</div>
                <div class="stat-label">üü¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.totalSubmissions}</div>
                <div class="stat-label">üì∏ –í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.pendingSubmissions}</div>
                <div class="stat-label">‚è≥ –û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.totalLavki}</div>
                <div class="stat-label">üíé –í—Å–µ–≥–æ –ª–∞–≤–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.activeTasks}</div>
                <div class="stat-label">üìã –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.pendingPurchaseRequests}</div>
                <div class="stat-label">üõí –û–∂–∏–¥–∞—é—Ç –ø–æ–∫—É–ø–∫–∏</div>
            </div>
        `;
        
        document.getElementById('stats-grid').innerHTML = statsHTML;
    } catch (error) {
        document.getElementById('stats-grid').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
async function loadSubmissions() {
    try {
        const submissions = await apiCall('/api/admin/submissions');
        const pendingSubmissions = submissions.filter(s => s.status === 'pending');
        
        if (pendingSubmissions.length === 0) {
            document.getElementById('submissions-list').innerHTML = `
                <div class="empty-state">
                    <div>üéâ</div>
                    <h3>–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</h3>
                    <p>–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã!</p>
                </div>
            `;
            return;
        }

        let submissionsHTML = '';
        pendingSubmissions.forEach(submission => {
            submissionsHTML += `
                <div class="submission-item">
                    <div class="submission-header">
                        <div>
                            <div class="submission-user">üë§ ${submission.userName}</div>
                            <div class="submission-task">üìã ${submission.taskName}</div>
                            <div style="margin-top: 5px; color: #7f8c8d; font-size: 12px;">
                                –ö–æ–Ω—Ç–∞–∫—Ç: ${submission.userContact}
                            </div>
                        </div>
                        <div>
                            <span class="status-badge status-pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>
                            <div style="margin-top: 5px; color: #7f8c8d; font-size: 12px;">
                                üíé +${submission.reward} –ª–∞–≤–æ–∫
                            </div>
                        </div>
                    </div>
                    
                    <img src="${submission.photo}" alt="–§–æ—Ç–æ –∑–∞–¥–∞–Ω–∏—è" class="submission-photo" 
                         onerror="this.src='https://via.placeholder.com/300x200/ECF0F1/666?text=–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏+—Ñ–æ—Ç–æ'">
                    
                    <div class="submission-actions">
                        <button onclick="approveSubmission(${submission.id})" class="btn btn-approve">
                            ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (+${submission.reward} –ª–∞–≤–æ–∫)
                        </button>
                        <button onclick="rejectSubmission(${submission.id})" class="btn btn-reject">
                            ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('submissions-list').innerHTML = submissionsHTML;
    } catch (error) {
        document.getElementById('submissions-list').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π</div>';
    }
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
async function approveSubmission(submissionId) {
  if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –ª–∞–≤–∫–∏?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
  
  try {
    showNotification('‚è≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ...', 'info');
    await apiCall(`/api/admin/submissions/${submissionId}/approve`, {
      method: 'POST'
    });
    
    showNotification('‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ! –õ–∞–≤–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã.');
    loadSubmissions();
    loadDashboard();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
  }
}

// –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
async function rejectSubmission(submissionId) {
  const rejectionReason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑", "–§–æ—Ç–æ –Ω–µ—á–µ—Ç–∫–æ–µ", "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ"):', '–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
  
  if (rejectionReason === null) return;
  
  if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ?\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞.')) return;
  
  try {
    showNotification('‚è≥ –û—Ç–∫–ª–æ–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ...', 'info');
    await apiCall(`/api/admin/submissions/${submissionId}/reject`, {
      method: 'POST',
      body: JSON.stringify({ rejectionReason })
    });
    
    showNotification('‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞.');
    loadSubmissions();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–∫—É–ø–∫—É
async function loadPurchaseRequests() {
    try {
        const requests = await apiCall('/api/admin/purchase-requests');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('total-purchases').textContent = requests.length;
        document.getElementById('pending-purchases').textContent = requests.filter(r => r.status === 'pending').length;
        document.getElementById('approved-purchases').textContent = requests.filter(r => r.status === 'approved').length;
        
        if (requests.length === 0) {
            document.getElementById('purchase-requests-list').innerHTML = `
                <div class="empty-state">
                    <div>üõí</div>
                    <h3>–ó–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–∫—É–ø–∫—É –Ω–µ—Ç</h3>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–∫—É–ø–∫—É —Ç–æ–≤–∞—Ä–æ–≤</p>
                </div>
            `;
            return;
        }

        let requestsHTML = '';
        requests.forEach(request => {
            const statusBadge = request.status === 'pending' ? 
                '<span class="status-badge status-pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>' :
                request.status === 'approved' ? 
                '<span class="status-badge status-approved">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>' :
                '<span class="status-badge status-rejected">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>';
            
            requestsHTML += `
                <div class="submission-item">
                    <div class="submission-header">
                        <div>
                            <div class="submission-user">üë§ ${request.userName}</div>
                            <div class="submission-task">üõí ${request.itemName}</div>
                            <div style="margin-top: 5px; color: #7f8c8d; font-size: 14px;">
                                üíé –¶–µ–Ω–∞: ${request.price} –ª–∞–≤–æ–∫ ‚Ä¢ 
                                üìÖ ${new Date(request.requestedAt).toLocaleDateString('ru-RU')}
                            </div>
                            ${request.adminNotes ? `
                                <div style="margin-top: 5px; color: #666; font-size: 13px;">
                                    <strong>–ó–∞–º–µ—Ç–∫–∏:</strong> ${request.adminNotes}
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            ${statusBadge}
                            <div style="margin-top: 5px; color: #7f8c8d; font-size: 12px;">
                                –ö–æ–Ω—Ç–∞–∫—Ç: ${request.userContact}
                            </div>
                        </div>
                    </div>
                    
                    ${request.status === 'pending' ? `
                        <div class="submission-actions">
                            <button onclick="processPurchaseRequest(${request.id}, 'approved')" class="btn btn-approve">
                                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É
                            </button>
                            <button onclick="processPurchaseRequest(${request.id}, 'rejected')" class="btn btn-reject">
                                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
                            </button>
                        </div>
                    ` : `
                        <div style="color: #7f8c8d; font-size: 14px; margin-top: 10px;">
                            –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${request.processedAt ? new Date(request.processedAt).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                        </div>
                    `}
                </div>
            `;
        });
        
        document.getElementById('purchase-requests-list').innerHTML = requestsHTML;
    } catch (error) {
        document.getElementById('purchase-requests-list').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</div>';
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–∫—É–ø–∫—É
async function processPurchaseRequest(requestId, status) {
  const action = status === 'approved' ? '–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å' : '–æ—Ç–∫–ª–æ–Ω–∏—Ç—å';
  const confirmMessage = status === 'approved' 
    ? '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É –∏ —Å–ø–∏—Å–∞—Ç—å –ª–∞–≤–∫–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.'
    : '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–∫—É–ø–∫—É?\n\n–õ–∞–≤–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.';
  
  if (!confirm(confirmMessage)) return;
  
  const adminNotes = status === 'rejected' ? 
    prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') : null;
  
  try {
    showNotification('‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞—è–≤–∫—É...', 'info');
    await apiCall(`/api/admin/purchase-requests/${requestId}/process`, {
      method: 'POST',
      body: JSON.stringify({ 
        status: status,
        adminNotes: adminNotes
      })
    });
    
    showNotification(`‚úÖ –ó–∞—è–≤–∫–∞ ${status === 'approved' ? '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}!`);
    loadPurchaseRequests();
    loadDashboard();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏', 'error');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
async function loadUsers() {
    try {
        const users = await apiCall('/api/admin/users');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('total-users').textContent = users.length;
        document.getElementById('total-lavki-users').textContent = users.reduce((sum, user) => sum + user.lavki, 0);
        
        const activeUsers = users.filter(user => {
            if (!user.lastActivity) return false;
            const lastActivity = new Date(user.lastActivity);
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            return lastActivity > weekAgo;
        });
        document.getElementById('active-users').textContent = activeUsers.length;
        
        if (users.length === 0) {
            document.getElementById('users-list').innerHTML = `
                <div class="empty-state">
                    <div>üë•</div>
                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                    <p>–ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞—á–Ω—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                </div>
            `;
            return;
        }

        let usersHTML = '';
        users.forEach(user => {
            const isActive = user.lastActivity && (new Date(user.lastActivity) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000));
            
            usersHTML += `
                <div class="submission-item user-item" data-user-id="${user.id}" data-user-name="${user.userName}">
                    <div class="submission-header">
                        <div>
                            <div class="submission-user">üë§ ${user.userName}</div>
                            <div style="display: flex; gap: 15px; margin-top: 5px; font-size: 14px;">
                                <span>üíé ${user.lavki} –ª–∞–≤–æ–∫</span>
                                <span>‚úÖ ${user.completedTasks || 0} –∑–∞–¥–∞–Ω–∏–π</span>
                                <span class="status-badge ${isActive ? 'status-approved' : 'status-rejected'}">
                                    ${isActive ? 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ö´ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                </span>
                            </div>
                            <div style="color: #7f8c8d; font-size: 12px; margin-top: 5px;">
                                –ö–æ–Ω—Ç–∞–∫—Ç: ${user.userContact}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #7f8c8d; font-size: 12px;">
                                üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${user.registrationDate ? new Date(user.registrationDate).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                            </div>
                            <div style="color: #7f8c8d; font-size: 12px; margin-top: 5px;">
                                üìç –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${user.lastActivity ? new Date(user.lastActivity).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="submission-actions">
                        <button onclick="viewUserDetails('${user.id}')" class="btn" style="background: #2196f3; color: white;">
                            üìä –î–µ—Ç–∞–ª–∏
                        </button>
                        <button onclick="editUserBalance('${user.id}', ${user.lavki})" class="btn" style="background: #ff9800; color: white;">
                            üíé –ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
                        </button>
                        <button onclick="resetUserCharacter('${user.id}')" class="btn" style="background: #f44336; color: white;">
                            üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                        </button>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('users-list').innerHTML = usersHTML;
    } catch (error) {
        document.getElementById('users-list').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
    }
}

// –î–û–ë–ê–í–õ–ï–ù–û: –°–±—Ä–æ—Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function resetUserCharacter(userId) {
  if (!confirm(`üö® –í–ù–ò–ú–ê–ù–ò–ï: –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—Å–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û –∏ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫:\n‚Ä¢ –û–±–Ω—É–ª–µ–Ω–∏—é –≤—Å–µ—Ö –ª–∞–≤–æ–∫\n‚Ä¢ –°–±—Ä–æ—Å—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–¥–∞–Ω–∏–π\n‚Ä¢ –£–¥–∞–ª–µ–Ω–∏—é –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫—É–ø–æ–∫\n‚Ä¢ –°–±—Ä–æ—Å—É –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏`)) return;
  
  const confirmReset = prompt('–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ "–°–ë–†–û–°–ò–¢–¨" (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫):');
  if (confirmReset !== '–°–ë–†–û–°–ò–¢–¨') {
    showNotification('‚ùå –°–±—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω', 'error');
    return;
  }
  
  try {
    showNotification('‚è≥ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...', 'info');
    await apiCall(`/api/admin/users/${userId}/reset`, {
      method: 'POST'
    });
    
    showNotification('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω!');
    loadUsers();
    loadDashboard();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞', 'error');
  }
}

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function filterUsers() {
    const search = document.getElementById('user-search').value.toLowerCase();
    const userItems = document.querySelectorAll('.user-item');
    
    userItems.forEach(item => {
        const userName = item.getAttribute('data-user-name').toLowerCase();
        if (userName.includes(search)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function viewUserDetails(userId) {
    try {
        const userInfo = await apiCall(`/api/admin/users/${userId}`);
        
        const submissionsHTML = userInfo.submissions.map(sub => `
            <div style="border: 1px solid #eee; padding: 10px; margin: 5px 0; border-radius: 5px;">
                <div><strong>${sub.taskName}</strong> (+${sub.reward} –ª–∞–≤–æ–∫)</div>
                <div style="font-size: 12px; color: #666;">
                    –°—Ç–∞—Ç—É—Å: ${sub.status === 'approved' ? '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : sub.status === 'pending' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç' : '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ'}
                    ‚Ä¢ ${new Date(sub.submittedAt).toLocaleDateString('ru-RU')}
                </div>
            </div>
        `).join('');
        
        const purchasesHTML = userInfo.purchases.map(purchase => `
            <div style="border: 1px solid #eee; padding: 10px; margin: 5px 0; border-radius: 5px;">
                <div><strong>${purchase.itemName}</strong> (${purchase.price} –ª–∞–≤–æ–∫)</div>
                <div style="font-size: 12px; color: #666;">
                    üìÖ ${new Date(purchase.purchasedAt).toLocaleDateString('ru-RU')}
                </div>
            </div>
        `).join('');
        
        const modalHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3>üìä –î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                    <div style="margin: 20px 0;">
                        <p><strong>ID:</strong> ${userInfo.id}</p>
                        <p><strong>–ò–º—è:</strong> ${userInfo.userName}</p>
                        <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${userInfo.userContact}</p>
                        <p><strong>üíé –ë–∞–ª–∞–Ω—Å:</strong> ${userInfo.lavki} –ª–∞–≤–æ–∫</p>
                        <p><strong>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π:</strong> ${userInfo.completedTasks}</p>
                        <p><strong>üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${userInfo.registrationDate ? new Date(userInfo.registrationDate).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                        <p><strong>üìä –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–æ–∫:</strong> ${userInfo.totalSubmissions}</p>
                        <p><strong>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:</strong> ${userInfo.approvedSubmissions}</p>
                        <p><strong>‚è≥ –û–∂–∏–¥–∞–µ—Ç:</strong> ${userInfo.pendingSubmissions}</p>
                        <p><strong>üõí –ü–æ–∫—É–ø–æ–∫:</strong> ${userInfo.totalPurchases}</p>
                    </div>
                    
                    <h4>üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞–Ω–∏–π:</h4>
                    <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
                        ${submissionsHTML || '<p>–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>'}
                    </div>
                    
                    <h4>üõí –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫:</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${purchasesHTML || '<p>–ü–æ–∫—É–ø–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>'}
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="closeModal()" class="btn" style="background: #666; color: white;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
    }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function editUserBalance(userId, currentBalance) {
  const newBalance = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${currentBalance} –ª–∞–≤–æ–∫`, currentBalance);
  
  if (newBalance === null) return;
  
  const balance = parseInt(newBalance);
  if (isNaN(balance) || balance < 0) {
    showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ (0 –∏–ª–∏ –±–æ–ª—å—à–µ)', 'error');
    return;
  }
  
  if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?\n\n–ë—ã–ª–æ: ${currentBalance} –ª–∞–≤–æ–∫\n–°—Ç–∞–Ω–µ—Ç: ${balance} –ª–∞–≤–æ–∫`)) return;
  
  try {
    showNotification('‚è≥ –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å...', 'info');
    await apiCall(`/api/admin/users/${userId}/balance`, {
      method: 'PUT',
      body: JSON.stringify({ lavki: balance })
    });
    
    showNotification('‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω!');
    loadUsers();
    loadDashboard();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞', 'error');
  }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeModal() {
    const modal = document.querySelector('[style*="position: fixed; top: 0; left: 0; width: 100%"]');
    if (modal) {
        modal.remove();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞–Ω–∏–π
async function loadTasks() {
    try {
        const tasks = await apiCall('/api/admin/tasks');
        
        let tasksHTML = '';
        tasks.forEach(task => {
            tasksHTML += `
                <div class="submission-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${task.name}</h4>
                            <p>üíé –ù–∞–≥—Ä–∞–¥–∞: ${task.reward} –ª–∞–≤–æ–∫</p>
                            <span class="status-badge ${task.active ? 'status-approved' : 'status-rejected'}">
                                ${task.active ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–æ' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–æ'}
                            </span>
                        </div>
                        <div>
                            <button onclick="toggleTask(${task.id}, ${!task.active})" class="btn" 
                                    style="background: ${task.active ? '#ff9800' : '#4caf50'}; color: white; margin: 2px;">
                                ${task.active ? '‚ùå –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('tasks-list').innerHTML = tasksHTML;
    } catch (error) {
        document.getElementById('tasks-list').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π</div>';
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
async function addNewTask() {
  const name = document.getElementById('new-task-name').value;
  const reward = document.getElementById('new-task-reward').value;
  
  if (!name || !reward) {
    showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
    return;
  }
  
  if (!confirm(`–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ?\n\n"${name}"\n–ù–∞–≥—Ä–∞–¥–∞: ${reward} –ª–∞–≤–æ–∫`)) return;
  
  try {
    showNotification('‚è≥ –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞–Ω–∏–µ...', 'info');
    await apiCall('/api/admin/tasks', {
      method: 'POST',
      body: JSON.stringify({ name, reward: parseInt(reward) })
    });
    
    showNotification('‚úÖ –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
    document.getElementById('new-task-name').value = '';
    document.getElementById('new-task-reward').value = '';
    loadTasks();
    loadDashboard();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
  }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞–Ω–∏—è
async function toggleTask(taskId, active) {
  const action = active ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
  
  if (!confirm(`${active ? '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚ùå –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'} —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ?`)) return;
  
  try {
    showNotification('‚è≥ –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞–Ω–∏–µ...', 'info');
    await apiCall(`/api/admin/tasks/${taskId}`, {
      method: 'PUT',
      body: JSON.stringify({ active })
    });
    
    showNotification(`‚úÖ –ó–∞–¥–∞–Ω–∏–µ ${active ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ'}`);
    loadTasks();
    loadDashboard();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞
async function loadShop() {
    try {
        const shopItems = await apiCall('/api/admin/shop');
        
        let shopHTML = '';
        shopItems.forEach(item => {
            shopHTML += `
                <div class="submission-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${item.name}</h4>
                            <p>üíé –¶–µ–Ω–∞: ${item.price} –ª–∞–≤–æ–∫</p>
                            <span class="status-badge ${item.active ? 'status-approved' : 'status-rejected'}">
                                ${item.active ? '‚úÖ –í –ø—Ä–æ–¥–∞–∂–µ' : '‚ùå –ù–µ –ø—Ä–æ–¥–∞–µ—Ç—Å—è'}
                            </span>
                        </div>
                        <div>
                            <button onclick="toggleShopItem(${item.id}, ${!item.active})" class="btn" 
                                    style="background: ${item.active ? '#ff9800' : '#4caf50'}; color: white; margin: 2px;">
                                ${item.active ? '‚ùå –°–Ω—è—Ç—å —Å –ø—Ä–æ–¥–∞–∂–∏' : '‚úÖ –í–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–æ–¥–∞–∂—É'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('shop-list').innerHTML = shopHTML;
    } catch (error) {
        document.getElementById('shop-list').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞</div>';
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
async function addNewShopItem() {
  const name = document.getElementById('new-item-name').value;
  const price = document.getElementById('new-item-price').value;
  
  if (!name || !price) {
    showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
    return;
  }
  
  if (!confirm(`–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä?\n\n"${name}"\n–¶–µ–Ω–∞: ${price} –ª–∞–≤–æ–∫`)) return;
  
  try {
    showNotification('‚è≥ –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä...', 'info');
    await apiCall('/api/admin/shop', {
      method: 'POST',
      body: JSON.stringify({ name, price: parseInt(price) })
    });
    
    showNotification('‚úÖ –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
    document.getElementById('new-item-name').value = '';
    document.getElementById('new-item-price').value = '';
    loadShop();
    loadDashboard();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
  }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞
async function toggleShopItem(itemId, active) {
  const action = active ? '–≤ –ø—Ä–æ–¥–∞–∂—É' : '—Å –ø—Ä–æ–¥–∞–∂–∏';
  
  if (!confirm(`${active ? '‚úÖ –í–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–æ–¥–∞–∂—É' : '‚ùå –°–Ω—è—Ç—å —Å –ø—Ä–æ–¥–∞–∂–∏'} —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?`)) return;
  
  try {
    showNotification('‚è≥ –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä...', 'info');
    await apiCall(`/api/admin/shop/${itemId}`, {
      method: 'PUT',
      body: JSON.stringify({ active })
    });
    
    showNotification(`‚úÖ –¢–æ–≤–∞—Ä ${active ? '–¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–¥–∞–∂—É' : '—Å–Ω—è—Ç —Å –ø—Ä–æ–¥–∞–∂–∏'}`);
    loadShop();
    loadDashboard();
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
  }
}

// –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
async function changePassword() {
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  
  if (!newPassword || !confirmPassword) {
    showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showNotification('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
    return;
  }
  
  if (newPassword.length < 4) {
    showNotification('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
    return;
  }
  
  if (!confirm('–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?\n\n–ó–∞–ø–æ–º–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å!')) return;
  
  try {
    showNotification('‚è≥ –ú–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å...', 'info');
    await apiCall('/api/admin/change-password', {
      method: 'POST',
      body: JSON.stringify({ newPassword })
    });
    
    showNotification('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!');
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-password').value = '';
  } catch (error) {
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è', 'error');
  }
}

// =====================
// üîÑ –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•
// =====================

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
function startAutoRefresh() {
  setInterval(() => {
    const activeSection = document.querySelector('.section.active');
    if (activeSection) {
      const sectionId = activeSection.id;
      
      if (sectionId === 'section-submissions') {
        loadSubmissions();
      } else if (sectionId === 'section-purchases') {
        loadPurchaseRequests();
      } else if (sectionId === 'section-dashboard') {
        loadDashboard();
      }
      // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    }
  }, 30000); // 30 —Å–µ–∫—É–Ω–¥
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
document.addEventListener('DOMContentLoaded', function() {
  const savedToken = localStorage.getItem('adminToken');
  if (savedToken) {
    authToken = savedToken;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
    loadDashboard();
    startAutoRefresh(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  }
});
